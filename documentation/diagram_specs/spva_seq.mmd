sequenceDiagram
    title PV Access Protocol Flow with Certificate Status

    participant Agent as EPICS Agent
    participant Peer as EPICS Peer
    participant PVACMS as PVACMS

    Note over Agent: Initial State: TLS Context Init

    %% Channel Search Phase
    Agent->>Peer: SEARCH (protocol=["tcp","tls"])
    Peer-->>Agent: SEARCH_RESPONSE (protocol="tls", address)
    Note over Agent,Peer: TCP Connection Established

    %% Certificate Status Check (if required)
    opt Certificate Status Required
        Agent->>PVACMS: Monitor Certificate Status
        Note over Agent: TLS Context: TcpReady
        PVACMS-->>Agent: Certificate Status Valid
        Note over Agent: TLS Context: TlsReady
    end

    %% Connection Validation
    Peer->>Agent: CONNECTION_VALIDATION Request
    Agent-->>Peer: CONNECTION_VALIDATION Response
    Peer-->>Agent: CONNECTION_VALIDATED

    %% Channel Creation
    Agent->>Peer: CREATE_CHANNEL
    Peer-->>Agent: CREATE_CHANNEL Response

    %% Operations (showing all possible interactions)
    par GET Operation
        Agent->>Peer: GET Request
        Peer-->>Agent: GET Response
    and MONITOR Operation
        Agent->>Peer: MONITOR Request
        loop Monitor Updates
            Peer-->>Agent: MONITOR Update
        end
    and RPC Operation
        Agent->>Peer: RPC Request
        Peer-->>Agent: RPC Response
    and PUT Operation
        Agent->>Peer: PUT Request
        Peer-->>Agent: PUT Response
    end

    %% Certificate Status Change Handling
    opt Certificate Status Change
        PVACMS-->>Agent: Certificate Status Changed
        Note over Agent: Update TLS Context State
        alt If Status Invalid
            Note over Agent: TLS Context: DegradedMode
        else If Status Valid
            Note over Agent: TLS Context: TlsReady
        end
    end 