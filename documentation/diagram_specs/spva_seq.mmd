sequenceDiagram
    title Secure PV Access Protocol Flow

    participant Agent as Secure EPICS Client
    participant Peer as Secure EPICS Server
    participant PVACMS as PVACMS

    Note over Agent,Peer: TLS Context Initialisation
    Note over Peer: Initial State<br>TLS Context: Init<br>Peer Certificate Status: UNKNOWN
    Note over Agent: Initial State<br>TLS Context: Init<br>Peer Certificate Status: UNKNOWN

    % Check Server Phase
    Note over Peer: Check if EPICS Server is Viable
    alt Server Certificate Found AND is VALID<br>OR `stop-if-no-cert` flag is not set
        %% Server Cert Validation Phase
        Note over Peer: Check Server Certificate Viability
        alt Server Certificate Configured <br>AND VALID
            alt Server Certificate Revocation Monitoring Required
                Peer-->>PVACMS: Monitor Certificate Status
                Note over Peer: TLS Context: TcpReady
            else
                Note over Peer: TLS Context: TlsReady
            end
        else
            Note over Peer: TLS Context: DegradedMode
        end

        Note over Agent,Peer: SEARCH Request
        %% Trust Validation Phase
        Note over Agent: Check for Trust Anchor
        alt No Trust Anchor Found
            Agent-->>Peer: SEARCH (protocol=["tcp"]) with retry
        else
            Agent-->>Peer: SEARCH (protocol=["tcp", "tls"]) with retry
            %% Client Cert Validation Phase
            Note over Agent: Check Client Certificate Viability
            alt Client Certificate Configured <br>AND VALID
                alt Client Certificate Revocation Monitoring Required
                    Agent-->>PVACMS: Monitor Certificate Status
                    Note over Agent: TLS Context: TcpReady
                else
                    Note over Agent: TLS Context: TlsReady
                end
            else
                Note over Agent: TLS Context: DegradedMode
            end
        end

        Note over Agent,Peer: Asynchronous Certificate Status Monitoring
        par Client Certificate Monitoring Updates
            loop
                alt
                    PVACMS-->>Agent: Certificate Status(GOOD)
                    Note over Agent: TLS Context: TlsReady
                else
                    PVACMS-->>Agent: Certificate Status(NOT_GOOD)
                    Note over Agent: TLS Context: DegradedMode
                end
            end
        and Server Certificate Monitoring Updates
            loop
                alt
                    PVACMS-->>Peer: Certificate Status(GOOD)
                    Note over Peer: TLS Context: TlsReady
                else
                    PVACMS-->>Peer: Certificate Status(NOT_GOOD)
                    Note over Peer: TLS Context: DegradedMode
                end
            end
        and Client's Peer Certificate Monitoring
            loop
                alt
                    PVACMS-->>Agent: peer_certificate(GOOD)
                    Note over Agent: Peer Certificate Status: GOOD
                else
                    PVACMS-->>Agent: peer_certificate(NOT_GOOD)
                    Note over Agent: Peer Certificate Status: NOT_GOOD
                end
            end
        and Server's Peer Certificate Monitoring
            loop
                alt
                    PVACMS-->>Peer: peer_certificate(GOOD)
                    Note over Peer: Peer Certificate Status: GOOD
                else
                    PVACMS-->>Peer: peer_certificate(NOT_GOOD)
                    Note over Peer: Peer Certificate Status: NOT_GOOD
                end
            end
        and Search Response and Connection Establishment

            Note over Agent,Peer: SEARCH Response 
            %% Server Response determination Phase
            alt Server TLS Context: DegradedMode
                Peer-->>Agent: SEARCH_RESPONSE (protocol="tcp", address)
                Agent->>Peer: TCP Connection initiated to `address`
            else Server TLS Context: TlsReady
                alt SEARCH protocol list contains "tls"
                    Peer-->>Agent: SEARCH_RESPONSE (protocol="tls", address)
                    Agent->>Peer: TLS Connection initiated to `address`
                else
                    Note over Peer: Check Server-only Authentication setting
                    alt Server-only Authenticated TLS allowed
                        Peer-->>Agent: SEARCH_RESPONSE (protocol="tcp", address)
                        Agent->>Peer: TLS Connection initiated to `address`
                    end
                end
            end

            % Connection Establishment Phase
            Note over Agent,Peer: TCP Connection/TLS Connection & HANDSHAKE 
            alt TCP Connection initiated
                Note over Agent, Peer: TCP Connection Established on `address`
            else 
                Note over Agent,Peer: TLS Connection Establishment begins on `address`
                alt Server Certificate Revocation Monitoring Required<br>AND Certificate Stapling Enabled<br>AND Server TLS Context: NOT TcpReady
                    Peer->>Agent: TLS_HANDSHAKE(peer_certificate, peer_certificate_status)
                    alt peer_certificate_status is GOOD
                        Note over Agent: Peer Certificate Status: GOOD
                    else peer_certificate_status is NOT_GOOD
                        Note over Agent: Peer Certificate Status: NOT_GOOD
                    end
                else
                    Peer->>Agent: TLS_HANDSHAKE(peer_certificate)
                end
                alt Client TLS Context: DegradedMode
                    Agent->>Peer: TLS_HANDSHAKE()
                else
                    Agent->>Peer: TLS_HANDSHAKE(peer_certificate)
                    alt received `peer_certificate` requires Revocation Monitoring AND NOT using stapled status
                        Peer-->>PVACMS: Monitor `peer_certificate` Status
                    end
                end

                alt received `peer_certificate` requires Revocation Monitoring AND NOT using stapled status
                    Agent-->>PVACMS: Monitor `peer_certificate` Status
                end
            end

            %% Connection Validation Phase
            Peer-->>Agent: CONNECTION_VALIDATION Request
            activate Agent
            Agent-->>Peer: CONNECTION_VALIDATION Response
            deactivate Agent
            activate Peer
            Peer-->>Agent: CONNECTION_VALIDATED
            deactivate Peer

            Note over Agent,Peer: Ready to VALIDATE CONNECTION?
            alt Client TLS Context: DegradedMode
                Agent-->>Peer: CONNECTION_VALIDATION Response
            else Client TLS Context: TlsReady
                alt `peer_certificate` requires Revocation Monitoring
                    alt Peer Certificate Status: GOOD
                        Agent-->>Peer: CONNECTION_VALIDATION Response
                    end
                else
                    Agent-->>Peer: CONNECTION_VALIDATION Response
                end
            end

            Note over Agent,Peer: Ready to signal CONNECTION VALIDATED?
            alt Server TLS Context: DegradedMode<br>OR Server TLS Context: TlsReady
                Peer-->>Agent: CONNECTION_VALIDATED
            end
        end

        Note over Agent,Peer: Create Channel
        %% Channel Creation
        Agent->>Peer: CREATE_CHANNEL
        activate Peer
        Peer-->>Agent: CREATE_CHANNEL Response
        deactivate Peer

        Note over Agent,Peer: Operation
        %% Operations
        alt
            Agent->>Peer: GET Request
            activate Peer
            Peer-->>Agent: GET Response(value)
            deactivate Peer
        else
            Agent->>Peer: MONITOR Request
            activate Peer
            loop
                Peer-->>Agent: MONITOR Subscrition(update)
            end
            deactivate Peer
        else
            Agent->>Peer: RPC Request
            activate Peer
            Peer-->>Agent: RPC Response(value)
            deactivate Peer
        else
            Agent-->>Peer: PUT Request(value)
        end
    end

